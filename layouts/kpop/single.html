{{ define "main" }}

<div class="group-detail-container">
  <a href="#" id="backLink" class="back-link">← 返回列表</a>
  
  <div id="groupData">
    <div class="loading">載入中...</div>
  </div>
</div>

<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/1Aiw6BhSJS9Fou5XIUN0BoqZM7ymDSJTtAcNJi7GTyqE/gviz/tq?tqx=out:json&sheet=KPOP";

// 從 URL 取得團體名稱參數
const urlParams = new URLSearchParams(window.location.search);
const groupSlug = urlParams.get('name');

// 設定返回連結
const pathParts = window.location.pathname.split('/');
const kpopIndex = pathParts.indexOf('kpop');
if (kpopIndex !== -1) {
  const basePath = pathParts.slice(0, kpopIndex + 1).join('/');
  document.getElementById('backLink').href = basePath + '/';
}

if (!groupSlug) {
  document.getElementById("groupData").innerHTML = `
    <div class="error">
      <h2>找不到團體</h2>
      <p>請從列表頁選擇團體</p>
    </div>
  `;
  throw new Error('No group specified');
}

// 所有欄位（除了團體名稱）
const displayFields = [
  "年資", "出道地", "性別", "出道日期", "解散日期", 
  "現任成員", "已離開成員",
  "官方粉絲名", "官方應援顏色", "顏色代碼", "官方應援物", 
  "所屬公司", "Wiki Link"
];

// 欄位的中文標籤
const fieldLabels = {
  "年資": "年資",
  "出道地": "出道地點",
  "性別": "性別",
  "出道日期": "出道日期",
  "解散日期": "解散日期",
  "現任成員": "現任成員",
  "已離開成員": "已離開成員(未參與回歸)",
  "官方粉絲名": "官方粉絲名",
  "官方應援顏色": "官方應援顏色",
  "顏色代碼": "顏色代碼",
  "官方應援物": "官方應援物",
  "所屬公司": "所屬經紀公司",
  "Wiki Link": "Wiki 連結"
};

// 日期格式化
function formatDate(dateStr) {
  if (!dateStr) return "";

  const match = dateStr.match(/^Date\((\d+),(\d+),(\d+)\)$/);
  if (match) {
    const year = match[1];
    const month = String(Number(match[2]) + 1).padStart(2, "0");
    const day = String(match[3]).padStart(2, "0");
    return `${year}/${month}/${day}`;
  }

  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;

  return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, "0")}/${String(d.getDate()).padStart(2, "0")}`;
}

// 將團體名稱轉換為 slug
function toSlug(name) {
  return name.toLowerCase().replace(/\s+/g, '-').replace(/[()]/g, '');
}

fetch(sheetURL)
  .then(r => r.text())
  .then(text => {
    const jsonText = text.replace(/^[^({]*\(/, "").replace(/\);?$/, "");
    const data = JSON.parse(jsonText);

    const cols = data.table.cols.map(c => c.label);
    const rows = data.table.rows.map(r =>
      r.c.map(c => (c && c.v ? c.v : ""))
    );

    // 找到團體名稱欄位的 index
    const groupIndex = cols.indexOf("團體");
    
    // 找到符合的團體
    const groupRow = rows.find(row => {
      const groupName = row[groupIndex];
      return toSlug(groupName) === groupSlug;
    });

    if (!groupRow) {
      const listPath = pathParts.slice(0, kpopIndex + 1).join('/') + '/';
      document.getElementById("groupData").innerHTML = `
        <div class="error">
          <h2>找不到此團體</h2>
          <p>可能是連結錯誤或資料已被移除</p>
          <a href="${listPath}" class="back-link">返回列表</a>
        </div>
      `;
      return;
    }

    // 取得團體名稱
    const groupName = groupRow[groupIndex];

    // 建立資料物件
    const groupData = {};
    cols.forEach((col, i) => {
      groupData[col] = groupRow[i];
    });

    // 渲染頁面
    let html = `<h1 class="group-title">${groupName}</h1>`;
    html += '<div class="info-grid">';

    displayFields.forEach(field => {
      let value = groupData[field] || "—";

      // 特殊處理
      if (field === "出道日期" || field === "解散日期") {
        value = formatDate(value) || "—";
      }

      if (field === "顏色代碼" && value !== "—") {
        value = `<span class="color-preview" style="background-color: ${value};"></span> ${value}`;
      }

      if (field === "Wiki Link" && value !== "—") {
        value = `<a href="${value}" target="_blank" class="wiki-link">前往 Wiki</a>`;
      }

      html += `
        <div class="info-item">
          <div class="info-label">${fieldLabels[field]}</div>
          <div class="info-value">${value}</div>
        </div>
      `;
    });

    html += '</div>';
    document.getElementById("groupData").innerHTML = html;
  })
  .catch(err => {
    document.getElementById("groupData").innerHTML = `
      <div class="error">
        <h2>載入失敗</h2>
        <p>無法取得資料，請稍後再試</p>
      </div>
    `;
    console.error(err);
  });
</script>

<style>
.group-detail-container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
}

.back-link {
  display: inline-block;
  color: #888;
  text-decoration: none;
  margin-bottom: 20px;
  font-size: 16px;
}

.back-link:hover {
  color: #333;
  text-decoration: underline;
}

.loading, .error {
  text-align: center;
  padding: 40px;
  color: #666;
}

.error {
  background: #f8f8f8;
  border-radius: 8px;
}

.group-title {
  font-size: 40px;
  font-weight: bold;
  margin-bottom: 30px;
  padding-bottom: 15px;
  border-bottom: 2px solid #dedede;
}

.info-grid {
  display: grid;
  gap: 20px;
}

.info-item {
  display: grid;
  grid-template-columns: 150px 1fr;
  gap: 15px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
}

.info-label {
  font-weight: bold;
  color: #333;
}

.info-value {
  color: #222;
  display: flex;
  align-items: center;
  gap: 10px;
}

.color-preview {
  display: inline-block;
  width: 24px;
  height: 24px;
  border-radius: 4px;
  border: 1px solid #ddd;
  vertical-align: middle;
}

.wiki-link {
  color: #4a90e2;
  text-decoration: none;
}

.wiki-link:hover {
  text-decoration: underline;
}

/* 手機版響應式 */
@media (max-width: 600px) {
  .info-item {
    grid-template-columns: 1fr;
    gap: 8px;
  }
  
  .info-label {
    font-size: 14px;
  }
}
</style>

{{ end }}