{{ define "main" }}

<div class="group-detail-container">
  <a href="#" id="backLink" class="back-link">⬅ 返回列表</a>
  
  <div id="groupData">
    <div class="loading">載入中...</div>
  </div>
</div>

<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/1Aiw6BhSJS9Fou5XIUN0BoqZM7ymDSJTtAcNJi7GTyqE/gviz/tq?tqx=out:json&sheet=KPOP";

const urlParams = new URLSearchParams(window.location.search);
const groupSlug = urlParams.get('name');

const pathParts = window.location.pathname.split('/');
const kpopIndex = pathParts.indexOf('kpop');
if (kpopIndex !== -1) {
  const basePath = pathParts.slice(0, kpopIndex + 1).join('/');
  document.getElementById('backLink').href = basePath + '/';
}

if (!groupSlug) {
  document.getElementById("groupData").innerHTML = `<div class="error"><h2>找不到團體</h2></div>`;
  throw new Error('No group specified');
}

const displayFields = ["年資", "出道地", "性別", "出道日期", "解散日期", "現役成員", "已離開成員", "官方粉絲名", "官方應援顏色", "官方應援物", "所屬公司", "Wiki Link"];

const fieldLabels = {
  "年資": "年資",
  "出道地": "出道地點",
  "性別": "性別",
  "出道日期": "出道日期",
  "解散日期": "解散日期",
  "現役成員": "現役成員",
  "已離開成員": "已離開成員(未參與回歸)",
  "官方粉絲名": "官方粉絲名",
  "官方應援顏色": "官方應援顏色",
  "官方應援物": "官方應援物",
  "所屬公司": "所屬經紀公司",
  "Wiki Link": "Wiki 連結"
};

function formatDate(s) {
  if (!s) return "";
  const m = s.match(/^Date\((\d+),(\d+),(\d+)\)$/);
  if (m) return `${m[1]}/${String(Number(m[2])+1).padStart(2,"0")}/${String(m[3]).padStart(2,"0")}`;
  const d = new Date(s);
  return isNaN(d) ? s : `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")}`;
}

function toSlug(n) {
  return n.toLowerCase().replace(/\s+/g, '-').replace(/[()]/g, '');
}

fetch(sheetURL)
  .then(r => r.text())
  .then(text => {
    const data = JSON.parse(text.replace(/^[^({]*\(/, "").replace(/\);?$/, ""));
    const cols = data.table.cols.map(c => c.label);
    const rows = data.table.rows.map(r => r.c.map(c => (c && c.v ? c.v : "")));
    const groupIndex = cols.indexOf("團體");
    const groupRow = rows.find(row => toSlug(row[groupIndex]) === groupSlug);

    if (!groupRow) {
      document.getElementById("groupData").innerHTML = `<div class="error"><h2>找不到此團體</h2></div>`;
      return;
    }

    const groupName = groupRow[groupIndex];
    const groupData = {};
    cols.forEach((col, i) => { groupData[col] = groupRow[i]; });

    let html = `<h1 class="group-title">${groupName}</h1><div class="info-grid">`;

    displayFields.forEach(field => {
      let value = groupData[field] || "";

      if ((field === "解散日期" || field === "現役成員" || field === "已離開成員") && !value) return;
      if (!value) value = "—";

      if (field === "出道日期" || field === "解散日期") {
        value = formatDate(value) || "—";
      }

      if (field === "官方應援顏色") {
        const colorNames = value !== "—" ? value.split("、").map(c => c.trim()).filter(c => c) : [];
        const colorCodes = (groupData["顏色代碼"] || "").split("、").map(c => c.trim()).filter(c => c);
        
        if (colorCodes.length > 0) {
          value = '<div class="color-list">';
          colorCodes.forEach((code, i) => {
            const name = colorNames[i] || "";
            value += `<div class="color-item"><span class="color-preview" style="background-color: ${code};"></span><span class="color-info">${name ? `<span class="color-name">${name}</span>` : ''}<span class="color-code">${code}</span></span></div>`;
          });
          value += '</div>';
        } else if (colorNames.length > 0) {
          value = colorNames.join("、");
        }
      }

      if (field === "Wiki Link" && value !== "—") {
        value = `<a href="${value}" target="_blank" class="wiki-link">前往 ${groupName} 維基百科網頁</a>`;
      }

      html += `<div class="info-item"><div class="info-label">${fieldLabels[field]}</div><div class="info-value">${value}</div></div>`;
    });

    html += '</div>';
    document.getElementById("groupData").innerHTML = html;
  })
  .catch(err => {
    document.getElementById("groupData").innerHTML = `<div class="error"><h2>載入失敗</h2></div>`;
    console.error(err);
  });
</script>

<style>
.group-detail-container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
}

.back-link {
  display: inline-block;
  color: #888;
  text-decoration: none;
  margin-bottom: 20px;
  font-size: 16px;
}

.back-link:hover {
  color: #333;
  text-decoration: underline;
}

.loading, .error {
  text-align: center;
  padding: 40px;
  color: #666;
}

.error {
  background: #f8f8f8;
  border-radius: 8px;
}

.group-title {
  font-size: 40px;
  font-weight: bold;
  margin-bottom: 30px;
  padding-bottom: 15px;
  border-bottom: 2px solid #dedede;
}

.info-grid {
  display: grid;
  gap: 20px;
}

.info-item {
  display: grid;
  grid-template-columns: 200px 1fr;
  gap: 15px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
}

.info-label {
  font-weight: bold;
  color: #333;
}

.info-value {
  color: #222;
}

.color-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.color-item {
  display: flex;
  align-items: center;
  gap: 10px;
}

.color-preview {
  display: inline-block;
  width: 30px;
  height: 30px;
  border-radius: 4px;
  border: 2px solid #999;
  flex-shrink: 0;
}

.color-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.color-name {
  font-size: 14px;
  color: #555;
}

.color-code {
  font-size: 12px;
  color: #888;
  font-family: monospace;
}

.wiki-link {
  color: #4a90e2;
  text-decoration: none;
}

.wiki-link:hover {
  text-decoration: underline;
}

@media (max-width: 600px) {
  .info-item {
    grid-template-columns: 1fr;
    gap: 8px;
  }
}
</style>

{{ end }}