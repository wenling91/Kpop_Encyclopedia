{{ define "main" }}

<h1>KPOP è³‡æ–™åº«</h1>

<input 
  type="text" 
  id="searchInput" 
  placeholder="æœå°‹åœ˜é«”åç¨±..." 
  style="width: 50%; padding: 8px; margin-bottom: 15px; font-size: 16px;"
/>

<div id="sheetData">è³‡æ–™è®€å–ä¸­...</div>

<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/1Aiw6BhSJS9Fou5XIUN0BoqZM7ymDSJTtAcNJi7GTyqE/gviz/tq?tqx=out:json&sheet=KPOP";

// è¦é¡¯ç¤ºçš„æ¬„ä½
const allowedCols = ["åœ˜é«”", "æ€§åˆ¥", "å‡ºé“æ—¥æœŸ", "å®˜æ–¹ç²‰çµ²å"];

// Google Sheet ä¸­ wiki é€£çµæ¬„ä½åç¨±
const wikiColName = "Wiki Link";

// å…¨éƒ¨è³‡æ–™åˆ—ï¼ˆæœå°‹ç”¨ï¼‰
let allRows = [];
let cols = [];
let allowedIndexes = [];
let wikiIndex = -1;

// æ—¥æœŸæ ¼å¼åŒ–ï¼ˆä½ å¯ä»¥è‡ªè¡Œèª¿æ•´æ ¼å¼ï¼‰
function formatDate(dateStr) {
  if (!dateStr) return "";

  // è™•ç† gviz çš„ Date(YYYY,MM,DD) æ ¼å¼
  const match = dateStr.match(/^Date\((\d+),(\d+),(\d+)\)$/);
  if (match) {
    const year = match[1];
    const month = String(Number(match[2]) + 1).padStart(2, "0"); // Google çš„æœˆä»½æ˜¯ 0-based
    const day = String(match[3]).padStart(2, "0");
    return `${year}/${month}/${day}`;
  }

  // å¦‚æœä¸æ˜¯ gviz æ—¥æœŸæ ¼å¼ï¼Œ fallback æˆä¸€èˆ¬æ ¼å¼
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;

  return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, "0")}/${String(d.getDate()).padStart(2, "0")}`;
}


fetch(sheetURL)
  .then(r => r.text())
  .then(text => {
    const jsonText = text.replace(/^[^({]*\(/, "").replace(/\);?$/, "");
    const data = JSON.parse(jsonText);

    // æ‰€æœ‰æ¬„ä½åç¨±
    cols = data.table.cols.map(c => c.label);

    // æ‰¾å‡ºé¡¯ç¤ºæ¬„ä½çš„ index
    allowedIndexes = allowedCols.map(name => cols.indexOf(name)).filter(i => i !== -1);

    // wiki æ¬„ä½ index
    wikiIndex = cols.indexOf(wikiColName);

    // å–å‡ºæ‰€æœ‰åˆ—
    allRows = data.table.rows.map(r =>
      r.c.map(c => (c && c.v ? c.v : ""))
    );

    renderTable(allRows);
  });

function renderTable(rows) {
  let html = "<table><tr>";
  allowedCols.forEach(c => html += `<th>${c}</th>`);
  html += "</tr>";

  rows.forEach(row => {
    html += "<tr>";

    allowedIndexes.forEach((colIndex, i) => {
      let cell = row[colIndex];

      // å‡ºé“æ—¥æœŸç¾åŒ–ï¼ˆåªé‡å°å‡ºé“æ—¥æœŸæ¬„ä½ï¼‰
      if (allowedCols[i] === "å‡ºé“æ—¥æœŸ") {
        cell = formatDate(cell);
      }

      // åœ˜é«” â†’ åŠ  wiki link
      if (allowedCols[i] === "åœ˜é«”") {
        const wikiURL = row[wikiIndex] || "#";
        html += `<td><a href="${wikiURL}" target="_blank">${cell}</a></td>`;
      } else {
        html += `<td>${cell}</td>`;
      }
    });

    html += "</tr>";
  });

  html += "</table>";
  document.getElementById("sheetData").innerHTML = html;
}

// ğŸ” æœå°‹ï¼ˆè‡ªå‹•ä¾ç…§ allowedIndexes & wikiIndexï¼‰
document.getElementById("searchInput").addEventListener("input", function () {
  const keyword = this.value.toLowerCase();

  const filtered = allRows.filter(row => {
    const groupIndex = cols.indexOf("åœ˜é«”");
    const groupName = row[groupIndex] ? row[groupIndex].toLowerCase() : "";
    return groupName.includes(keyword);
  });

  renderTable(filtered);
});
</script>

<style>
table {
  border-collapse: collapse;
  width: 100%;
  display: block;
  overflow-x: auto;
  white-space: nowrap;
}
th, td {
  border: 1px solid #ccc;
  padding: 8px;
}
</style>

{{ end }}
