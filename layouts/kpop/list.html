{{ define "main" }}

<div class="search-container">
  <div class="search-box">
    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"></circle>
      <path d="m21 21-4.35-4.35"></path>
    </svg>
    <input 
      type="text" 
      id="searchInput" 
      placeholder="搜尋團體名稱..."
    />
    <button id="clearBtn" class="clear-btn" style="display: none;">✕</button>
  </div>
</div>

<div id="sheetData">資料讀取中...</div>

<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/1Aiw6BhSJS9Fou5XIUN0BoqZM7ymDSJTtAcNJi7GTyqE/gviz/tq?tqx=out:json&sheet=KPOP";

// 要顯示的欄位
const allowedCols = ["團體", "出道日期", "官方粉絲名", "現役成員"];

// 欄位的顯示名稱（自訂標題）
const colLabels = {
  "團體": "團體名稱",
  "出道日期": "出道日期",
  "官方粉絲名": "官方粉絲名",
  "現役成員": "現役成員"
};

// 全部資料列（搜尋用）
let allRows = [];
let filteredRows = [];
let cols = [];
let allowedIndexes = [];
let wikiIndex = -1;
let currentSortCol = null;
let currentSortAsc = true;

// 日期格式化
function formatDate(dateStr) {
  if (!dateStr) return "";

  const match = dateStr.match(/^Date\((\d+),(\d+),(\d+)\)$/);
  if (match) {
    const year = match[1];
    const month = String(Number(match[2]) + 1).padStart(2, "0");
    const day = String(match[3]).padStart(2, "0");
    return `${year}/${month}/${day}`;
  }

  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;

  return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, "0")}/${String(d.getDate()).padStart(2, "0")}`;
}

// 將日期轉換為可排序的數字
function parseDateForSort(dateStr) {
  if (!dateStr) return 0;
  
  const match = dateStr.match(/^Date\((\d+),(\d+),(\d+)\)$/);
  if (match) {
    const year = parseInt(match[1]);
    const month = parseInt(match[2]);
    const day = parseInt(match[3]);
    return new Date(year, month, day).getTime();
  }
  
  const d = new Date(dateStr);
  return isNaN(d) ? 0 : d.getTime();
}

fetch(sheetURL)
  .then(r => r.text())
  .then(text => {
    const jsonText = text.replace(/^[^({]*\(/, "").replace(/\);?$/, "");
    const data = JSON.parse(jsonText);

    cols = data.table.cols.map(c => c.label);
    allowedIndexes = allowedCols.map(name => cols.indexOf(name)).filter(i => i !== -1);
    wikiIndex = cols.indexOf("Wiki Link");

    allRows = data.table.rows.map(r =>
      r.c.map(c => (c && c.v ? c.v : ""))
    );

    filteredRows = allRows;
    renderTable(filteredRows);
  })
  .catch(err => {
    document.getElementById("sheetData").innerHTML = "資料載入失敗";
    console.error(err);
  });

function renderTable(rows) {
  let html = '<div class="table-wrapper">';
  html += '<table><thead><tr>';
  
  allowedCols.forEach((c, i) => {
    const sortIcon = currentSortCol === c ? (currentSortAsc ? ' ▲' : ' ▼') : '';
    const thClass = i === 0 ? 'frozen-col' : '';
    html += `<th class="${thClass}" onclick="sortTable('${c}')" style="cursor: pointer;">${colLabels[c] || c}${sortIcon}</th>`;
  });
  html += "</tr></thead><tbody>";

  rows.forEach(row => {
    html += "<tr>";

    allowedIndexes.forEach((colIndex, i) => {
      let cell = row[colIndex];

      if (allowedCols[i] === "出道日期") {
        cell = formatDate(cell);
      }

      if (allowedCols[i] === "團體") {
        const slug = cell.toLowerCase().replace(/\s+/g, '-').replace(/[()]/g, '');
        const basePath = window.location.pathname.split('/kpop')[0];
        html += `<td class="frozen-col"><a href="${basePath}/kpop/group/?name=${encodeURIComponent(slug)}">${cell}</a></td>`;
      } else {
        html += `<td>${cell}</td>`;
      }
    });

    html += "</tr>";
  });

  html += "</tbody></table></div>";
  document.getElementById("sheetData").innerHTML = html;
}

// 排序功能
function sortTable(colName) {
  const colIndex = cols.indexOf(colName);
  
  if (currentSortCol === colName) {
    currentSortAsc = !currentSortAsc;
  } else {
    currentSortCol = colName;
    currentSortAsc = true;
  }

  const sortedRows = [...filteredRows].sort((a, b) => {
    let valA = a[colIndex] || "";
    let valB = b[colIndex] || "";

    if (colName === "出道日期") {
      valA = parseDateForSort(valA);
      valB = parseDateForSort(valB);
      return currentSortAsc ? valA - valB : valB - valA;
    }

    valA = String(valA).toLowerCase();
    valB = String(valB).toLowerCase();

    if (valA < valB) return currentSortAsc ? -1 : 1;
    if (valA > valB) return currentSortAsc ? 1 : -1;
    return 0;
  });

  renderTable(sortedRows);
}

// 搜尋功能
const searchInput = document.getElementById("searchInput");
const clearBtn = document.getElementById("clearBtn");

searchInput.addEventListener("input", function () {
  const keyword = this.value.toLowerCase();
  clearBtn.style.display = keyword ? "block" : "none";

  filteredRows = allRows.filter(row => {
    const groupIndex = cols.indexOf("團體");
    const groupName = row[groupIndex] ? row[groupIndex].toLowerCase() : "";
    return groupName.includes(keyword);
  });

  currentSortCol = null;
  currentSortAsc = true;
  renderTable(filteredRows);
});

clearBtn.addEventListener("click", function () {
  searchInput.value = "";
  clearBtn.style.display = "none";
  filteredRows = allRows;
  currentSortCol = null;
  currentSortAsc = true;
  renderTable(filteredRows);
  searchInput.focus();
});
</script>

<style>
.search-container {
  margin-bottom: 20px;
  display: flex;
  justify-content: center;
}

.search-box {
  position: relative;
  width: 100%;
  max-width: 500px;
  display: flex;
  align-items: center;
}

.search-icon {
  position: absolute;
  left: 12px;
  color: #999;
  pointer-events: none;
}

#searchInput {
  width: 100%;
  padding: 12px 40px 12px 40px;
  font-size: 16px;
  border: 2px solid #e0e0e0;
  border-radius: 24px;
  outline: none;
  transition: all 0.3s ease;
  background: #f8f9fa;
}

#searchInput:focus {
  border-color: #4a90e2;
  background: white;
  box-shadow: 0 2px 8px rgba(74, 144, 226, 0.15);
}

#searchInput::placeholder {
  color: #aaa;
}

.clear-btn {
  position: absolute;
  right: 12px;
  background: #ddd;
  border: none;
  border-radius: 50%;
  width: 22px;
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 14px;
  color: #666;
  transition: all 0.2s ease;
  padding: 0;
  line-height: 1;
}

.clear-btn:hover {
  background: #ccc;
  color: #333;
}

.table-wrapper {
  max-height: 600px;
  overflow: auto;
  position: relative;
  border: 1px solid #ccc;
}

table {
  border-collapse: collapse;
  width: max-content;
  min-width: 100%;
  white-space: nowrap;
}

th, td {
  border: 1px solid #ccc;
  padding: 8px 12px;
  text-align: left;
  min-width: 120px;
}

thead {
  position: sticky;
  top: 0;
  z-index: 20;
}

th {
  background: white;
  color: black;
  font-weight: bold;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  user-select: none;
}

th:hover {
  background: #f0f0f0;
}

.frozen-col {
  position: sticky;
  left: 0;
  background: white;
  color: black;
  z-index: 15;
  box-shadow: 2px 0 4px rgba(0,0,0,0.1);
}

th.frozen-col {
  z-index: 25;
}

td {
  background: inherit;
}

a {
  color: inherit;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}
</style>

{{ end }}