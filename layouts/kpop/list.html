{{ define "main" }}

<div class="search-container">
  <div class="search-box">
    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"></circle>
      <path d="m21 21-4.35-4.35"></path>
    </svg>
    <input 
      type="text" 
      id="searchInput" 
      placeholder="æœå°‹åœ˜é«”åç¨±..."
    />
    <button id="clearBtn" class="clear-btn" style="display: none;">âœ•</button>
  </div>
</div>

<div id="sheetData">è³‡æ–™è®€å–ä¸­...</div>

<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/1Aiw6BhSJS9Fou5XIUN0BoqZM7ymDSJTtAcNJi7GTyqE/gviz/tq?tqx=out:json&sheet=KPOP";

// è¦é¡¯ç¤ºçš„æ¬„ä½
const allowedCols = ["åœ˜é«”", "å‡ºé“æ—¥æœŸ", "å®˜æ–¹ç²‰çµ²å", "ç¾å½¹æˆå“¡"];

// Google Sheet ä¸­ wiki é€£çµæ¬„ä½åç¨±
const wikiColName = "Wiki Link";

// å…¨éƒ¨è³‡æ–™åˆ—ï¼ˆæœå°‹ç”¨ï¼‰
let allRows = [];
let cols = [];
let allowedIndexes = [];
let wikiIndex = -1;

// æ—¥æœŸæ ¼å¼åŒ–ï¼ˆä½ å¯ä»¥è‡ªè¡Œèª¿æ•´æ ¼å¼ï¼‰
function formatDate(dateStr) {
  if (!dateStr) return "";

  // è™•ç† gviz çš„ Date(YYYY,MM,DD) æ ¼å¼
  const match = dateStr.match(/^Date\((\d+),(\d+),(\d+)\)$/);
  if (match) {
    const year = match[1];
    const month = String(Number(match[2]) + 1).padStart(2, "0"); // Google çš„æœˆä»½æ˜¯ 0-based
    const day = String(match[3]).padStart(2, "0");
    return `${year}/${month}/${day}`;
  }

  // å¦‚æœä¸æ˜¯ gviz æ—¥æœŸæ ¼å¼ï¼Œ fallback æˆä¸€èˆ¬æ ¼å¼
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;

  return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, "0")}/${String(d.getDate()).padStart(2, "0")}`;
}


fetch(sheetURL)
  .then(r => r.text())
  .then(text => {
    const jsonText = text.replace(/^[^({]*\(/, "").replace(/\);?$/, "");
    const data = JSON.parse(jsonText);

    // æ‰€æœ‰æ¬„ä½åç¨±
    cols = data.table.cols.map(c => c.label);

    // æ‰¾å‡ºé¡¯ç¤ºæ¬„ä½çš„ index
    allowedIndexes = allowedCols.map(name => cols.indexOf(name)).filter(i => i !== -1);

    // wiki æ¬„ä½ index
    wikiIndex = cols.indexOf(wikiColName);

    // å–å‡ºæ‰€æœ‰åˆ—
    allRows = data.table.rows.map(r =>
      r.c.map(c => (c && c.v ? c.v : ""))
    );

    renderTable(allRows);
  });

function renderTable(rows) {
  let html = '<div class="table-wrapper">';
  html += '<table><thead><tr>';
  
  allowedCols.forEach(c => {
    html += `<th>${c}</th>`;
  });
  html += "</tr></thead><tbody>";

  rows.forEach(row => {
    html += "<tr>";

    allowedIndexes.forEach((colIndex, i) => {
      let cell = row[colIndex];

      // å‡ºé“æ—¥æœŸç¾åŒ–ï¼ˆåªé‡å°å‡ºé“æ—¥æœŸæ¬„ä½ï¼‰
      if (allowedCols[i] === "å‡ºé“æ—¥æœŸ") {
        cell = formatDate(cell);
      }

      // åœ˜é«” â†’ åŠ å…§éƒ¨é é¢ link (ä½¿ç”¨ç›¸å°è·¯å¾‘)
      if (allowedCols[i] === "åœ˜é«”") {
        // å°‡åœ˜é«”åç¨±è½‰æ›ç‚º URL slugï¼ˆç§»é™¤ç©ºæ ¼ã€è½‰å°å¯«ï¼‰
        const slug = cell.toLowerCase().replace(/\s+/g, '-').replace(/[()]/g, '');
        const basePath = window.location.pathname.split('/kpop')[0];
        html += `<td><a href="${basePath}/kpop/group/?name=${encodeURIComponent(slug)}">${cell}</a></td>`;
      } else {
        html += `<td>${cell}</td>`;
      }
    });

    html += "</tr>";
  });

  html += "</tbody></table></div>";
  document.getElementById("sheetData").innerHTML = html;
}

// ğŸ” æœå°‹åŠŸèƒ½
const searchInput = document.getElementById("searchInput");
const clearBtn = document.getElementById("clearBtn");

searchInput.addEventListener("input", function () {
  const keyword = this.value.toLowerCase();
  
  // é¡¯ç¤º/éš±è—æ¸…é™¤æŒ‰éˆ•
  clearBtn.style.display = keyword ? "block" : "none";

  const filtered = allRows.filter(row => {
    const groupIndex = cols.indexOf("åœ˜é«”");
    const groupName = row[groupIndex] ? row[groupIndex].toLowerCase() : "";
    return groupName.includes(keyword);
  });

  renderTable(filtered);
});

// æ¸…é™¤æœå°‹
clearBtn.addEventListener("click", function () {
  searchInput.value = "";
  clearBtn.style.display = "none";
  renderTable(allRows);
  searchInput.focus();
});
</script>

<style>
/* æœå°‹å®¹å™¨ */
.search-container {
  margin-bottom: 20px;
  display: flex;
  justify-content: center;
}

.search-box {
  position: relative;
  width: 100%;
  max-width: 500px;
  display: flex;
  align-items: center;
}

.search-icon {
  position: absolute;
  left: 12px;
  color: #999;
  pointer-events: none;
}

#searchInput {
  width: 100%;
  padding: 12px 40px 12px 40px;
  font-size: 16px;
  border: 2px solid #e0e0e0;
  border-radius: 24px;
  outline: none;
  transition: all 0.3s ease;
  background: #f8f9fa;
}

#searchInput:focus {
  border-color: #4a90e2;
  background: white;
  box-shadow: 0 2px 8px rgba(74, 144, 226, 0.15);
}

#searchInput::placeholder {
  color: #aaa;
}

.clear-btn {
  position: absolute;
  right: 12px;
  background: #ddd;
  border: none;
  border-radius: 50%;
  width: 22px;
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 14px;
  color: #666;
  transition: all 0.2s ease;
  padding: 0;
  line-height: 1;
}

.clear-btn:hover {
  background: #ccc;
  color: #333;
}

/* è¡¨æ ¼æ¨£å¼ */
.table-wrapper {
  max-height: 600px;
  overflow-y: auto;
  overflow-x: auto;
  position: relative;
  max-width: 1200px;
  margin: 0 auto;
}

table {
  border-collapse: collapse;
  width: 100%;
  white-space: nowrap;
  table-layout: fixed;
}

th, td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: left;
}

/* å‡çµæ¨™é¡Œåˆ— */
thead {
  position: sticky;
  top: 0;
  z-index: 10;
}

th {
  background: white;
  color: black;
  font-weight: bold;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

td {
  background: inherit;
}

/* é€£çµæ¨£å¼ */
a {
  color: inherit;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}
</style>

{{ end }}